<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Gerar Contracheque</title>

<link rel="stylesheet" href="style.css">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>
<script src="auth.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>

.secao{
margin-top:20px;
padding:15px;
background:#1e1e1e;
border-radius:8px;
}

input{
margin-bottom:8px;
}

.contrachequePDF{
background:white;
color:black;
padding:20px;
width:800px;
margin-top:30px;
}

</style>
</head>

<body>

<div class="container">

<h1>Gerar Contracheque</h1>
<h3 id="nomeFuncionario"></h3>

<label>Mês da competência</label>
<input type="number" id="mes">

<label>Ano da competência</label>
<input type="number" id="ano">

<div class="secao">
<h3>Vencimentos (VALORES EM R$)</h3>

<input type="number" id="he50" placeholder="Horas extras 50% (R$)">
<input type="number" id="he100" placeholder="Horas extras 100% (R$)">
<input type="number" id="noturno" placeholder="Adicional noturno (R$)">
<input type="number" id="insal" placeholder="Insalubridade (R$)">
<input type="number" id="peric" placeholder="Periculosidade (R$)">
<input type="number" id="bonus" placeholder="Bônus / Comissão (R$)">
</div>

<div class="secao">
<h3>Descontos</h3>

<input type="number" id="faltas" placeholder="Faltas injustificadas (DIAS)">
<input type="number" id="dependentes" placeholder="Dependentes IRRF (QTDE)">

<input type="number" id="vt" placeholder="Vale transporte (R$)">
<input type="number" id="vr" placeholder="Vale refeição (R$)">
<input type="number" id="pensao" placeholder="Pensão alimentícia (R$)">
<input type="number" id="outros" placeholder="Outros descontos (R$)">
</div>

<br>

<button onclick="calcular()">Calcular</button>
<button onclick="salvar()">Salvar no banco</button>
<button onclick="gerarPDF()">Gerar PDF</button>
<button onclick="location='dashboard.html'">Voltar</button>

<hr>

<div id="resumo"></div>

<div id="areaPDF"></div>

</div>

<script>

protegerPagina()

const params=new URLSearchParams(window.location.search)
const uid=params.get("uid")

let funcionario
let resultadoFinal=null

async function carregarFuncionario(){

const {data,error}=await supabaseClient
.from("funcionarios")
.select("*")
.eq("uid",uid)
.single()

if(error){
alert("Erro ao carregar funcionário")
return
}

funcionario=data
nomeFuncionario.innerText=data.nome+" | CPF "+data.cpf
}

carregarFuncionario()

function inss(base){
if(base<=1412) return base*0.075
if(base<=2666.68) return 1412*0.075+(base-1412)*0.09
if(base<=4000.03) return 1412*0.075+1254.68*0.09+(base-2666.68)*0.12
return 1412*0.075+1254.68*0.09+1333.35*0.12+(base-4000.03)*0.14
}

function irrf(base,dep){
base-=dep*189.59
if(base<=2112) return 0
if(base<=2826.65) return base*0.075-158.4
if(base<=3751.05) return base*0.15-370.4
if(base<=4664.68) return base*0.225-651.73
return base*0.275-884.96
}

function calcular(){

const salario=Number(funcionario.salario||0)
const faltasDias=Number(faltas.value||0)
const depend=Number(dependentes.value||0)

const descontoFaltas=(salario/30)*faltasDias

const vencimentos=
salario+
Number(he50.value||0)+
Number(he100.value||0)+
Number(noturno.value||0)+
Number(insal.value||0)+
Number(peric.value||0)+
Number(bonus.value||0)

const baseINSS=vencimentos-descontoFaltas
const valorINSS=inss(baseINSS)

const baseIRRF=baseINSS-valorINSS
const valorIRRF=irrf(baseIRRF,depend)

const fgts=baseINSS*0.08

const descontos=
descontoFaltas+
valorINSS+
valorIRRF+
Number(vt.value||0)+
Number(vr.value||0)+
Number(pensao.value||0)+
Number(outros.value||0)

const liquido=vencimentos-descontos

resultadoFinal={
salario,
vencimentos,
descontoFaltas,
valorINSS,
valorIRRF,
fgts,
liquido
}

resumo.innerHTML=`
<h3>Resumo do cálculo</h3>
Salário base: R$ ${salario.toFixed(2)}<br>
Total vencimentos: R$ ${vencimentos.toFixed(2)}<br>
INSS: R$ ${valorINSS.toFixed(2)}<br>
IRRF: R$ ${valorIRRF.toFixed(2)}<br>
FGTS: R$ ${fgts.toFixed(2)}<br>
<h2>Líquido: R$ ${liquido.toFixed(2)}</h2>
`

areaPDF.innerHTML=`
<div class="contrachequePDF">
<h2>CONTRACHEQUE</h2>
Funcionário: ${funcionario.nome}<br>
CPF: ${funcionario.cpf}<br>
Competência: ${mes.value}/${ano.value}<br>
<hr>
Salário base: R$ ${salario.toFixed(2)}<br>
Total vencimentos: R$ ${vencimentos.toFixed(2)}<br>
INSS: R$ ${valorINSS.toFixed(2)}<br>
IRRF: R$ ${valorIRRF.toFixed(2)}<br>
FGTS: R$ ${fgts.toFixed(2)}<br>
<hr>
<b>Líquido: R$ ${liquido.toFixed(2)}</b>
</div>
`
}

async function salvar(){

if(!resultadoFinal){
alert("Calcule primeiro")
return
}

await supabaseClient.from("contracheques").insert([{
funcionario_uid:uid,
competencia_mes:mes.value,
competencia_ano:ano.value,
salario_base:resultadoFinal.salario,
base_inss:resultadoFinal.vencimentos,
base_irrf:resultadoFinal.vencimentos,
base_fgts:resultadoFinal.vencimentos,
inss:resultadoFinal.valorINSS,
irrf:resultadoFinal.valorIRRF,
fgts:resultadoFinal.fgts,
salario_liquido:resultadoFinal.liquido
}])

alert("Contracheque salvo")
}

function gerarPDF(){

if(!resultadoFinal){
alert("Calcule primeiro")
return
}

html2pdf().from(areaPDF).save("contracheque.pdf")
}

</script>
</body>
</html>
