<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Funcionários - Controle CLT Pro</title>
<link rel="stylesheet" href="style.css">

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

</head>

<body>

<div class="container">

<h1>Funcionários</h1>

<table border="1" width="100%">
<thead>
<tr>
<th>Nome</th>
<th>CPF</th>
<th>Cargo</th>
<th>Setor</th>
<th>Ações</th>
</tr>
</thead>

<tbody id="listaFuncionarios"></tbody>
</table>

<br>
<button onclick="window.location='dashboard.html'">Voltar</button>

</div>

<script>

/* ========================= */
/* PROTEÇÃO LOGIN */
/* ========================= */
if(localStorage.getItem("logado")!=="sim"){
location="login.html"
}

let funcionarios = []

/* ============================= */
/* CARREGAR FUNCIONÁRIOS DO BANCO */
/* ============================= */
async function carregarFuncionarios(){

const { data, error } = await supabaseClient
.from("funcionarios")
.select("*")
.order("nome",{ascending:true})

if(error){
alert("Erro ao carregar funcionários")
console.error(error)
return
}

funcionarios = data
renderTabela()
}

/* ============================= */
/* RENDERIZAR TABELA */
/* ============================= */
function renderTabela(){

const lista = document.getElementById("listaFuncionarios")

if(!lista){
console.error("Elemento listaFuncionarios não existe")
return
}

lista.innerHTML=""

funcionarios.forEach((f,i)=>{

lista.innerHTML += `
<tr>
<td>${f.nome||""}</td>
<td>${f.cpf||""}</td>
<td>${f.cargo||""}</td>
<td>${f.setor||""}</td>

<td>
<button onclick="excluir(${i})">Excluir</button>
</td>
</tr>
`
})

}

/* ============================= */
/* EXCLUIR FUNCIONÁRIO */
/* ============================= */
async function excluir(i){

if(!confirm("Excluir funcionário?")) return

const id = funcionarios[i].id

const { error } = await supabaseClient
.from("funcionarios")
.delete()
.eq("id", id)

if(error){
alert("Erro ao excluir")
console.error(error)
return
}

alert("Funcionário excluído")
carregarFuncionarios()
}

/* ============================= */
/* INICIAR */
/* ============================= */
carregarFuncionarios()

</script>

</body>
</html>
