<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Funcionários</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>
<link rel="stylesheet" href="style.css">
</head>

<body>

<h1>Funcionários</h1>

<input id="pesquisa" placeholder="Pesquisar nome..." oninput="filtrar()">

<select id="filtroUnidade" onchange="filtrar()">
<option value="">Todas unidades</option>
<option value="Sabara">Sabara</option>
<option value="Cruzeiro da Fortaleza">Cruzeiro da Fortaleza</option>
<option value="Ocidental">Ocidental</option>
<option value="Aguas Lindas">Aguas Lindas</option>
<option value="Guimarania">Guimarania</option>
</select>

<table>
<thead>
<tr>
<th>Nome</th>
<th>CPF</th>
<th>Cargo</th>
<th>Setor</th>
<th>Ações</th>
</tr>
</thead>

<tbody id="lista"></tbody>
</table>

<button onclick="voltar()">Voltar</button>

<script>

/* ========================= */
/* CARREGAR FUNCIONÁRIOS */
/* ========================= */

let funcionarios=[]

async function carregarFuncionarios(){

const { data, error } = await supabaseClient
.from("funcionarios")
.select("*")
.order("nome",{ascending:true})

if(error){
alert("Erro ao carregar funcionários")
console.error(error)
return
}

funcionarios = data || []
renderTabela(funcionarios)
}

/* ========================= */
/* RENDERIZAR TABELA */
/* ========================= */

function renderTabela(lista){

const tbody=document.getElementById("lista")
tbody.innerHTML=""

lista.forEach(f=>{

tbody.innerHTML += `
<tr>
<td>${f.nome || ""}</td>
<td>${f.cpf || ""}</td>
<td>${f.cargo || ""}</td>
<td>${f.setor || ""}</td>
<td>
<button onclick="ver('${f.uid}')">Ver</button>
<button onclick="editar('${f.uid}')">Editar</button>
<button onclick="excluir('${f.uid}')">Excluir</button>
<button onclick="gerarContracheque('${f.uid}')">Contracheque</button>
</td>
</tr>
`
})
}

/* ========================= */
/* FILTRAR */
/* ========================= */

function filtrar(){

const termo=document.getElementById("pesquisa").value.toLowerCase()
const unidade=document.getElementById("filtroUnidade").value

const filtrados = funcionarios.filter(f=>{

const nomeMatch = (f.nome || "").toLowerCase().includes(termo)
const unidadeMatch = !unidade || (f.unidade || "") === unidade

return nomeMatch && unidadeMatch
})

renderTabela(filtrados)
}

/* ========================= */
/* AÇÕES */
/* ========================= */

function ver(uid){
localStorage.setItem("funcionarioUID",uid)
location="ficha.html"
}

function editar(uid){
localStorage.setItem("funcionarioEditando",uid)
location="cadastro.html"
}

async function excluir(uid){

if(!confirm("Excluir funcionário?")) return

const { error } = await supabaseClient
.from("funcionarios")
.delete()
.eq("uid",uid)

if(error){
alert("Erro ao excluir")
console.error(error)
return
}

alert("Excluído com sucesso")
carregarFuncionarios()
}

/* ========================= */
/* GERAR CONTRACHEQUE */
/* ========================= */

function gerarContracheque(uid){
location = "contracheque.html?uid=" + uid
}

/* ========================= */
/* VOLTAR */
/* ========================= */

function voltar(){
location="dashboard.html"
}

/* ========================= */
/* INICIAR */
/* ========================= */

carregarFuncionarios()

</script>

<!-- PROTEÇÃO LOGIN -->
<script src="auth.js"></script>
<script>
window.addEventListener("DOMContentLoaded", protegerPagina)
</script>

</body>
</html>
