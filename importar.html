<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Importador Profissional de Funcionários</title>
<link rel="stylesheet" href="style.css">

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{background:#111;color:white;font-family:Arial}
.container{max-width:900px;margin:40px auto;background:#1f1f1f;padding:30px;border-radius:8px}
select,input,button{width:100%;margin-top:10px;padding:10px;border-radius:6px;border:none}
button{cursor:pointer;background:#2ecc71;font-weight:bold}
.btn-sec{background:#555}
.preview{
margin-top:20px;
max-height:300px;
overflow:auto;
background:#000;
padding:10px;
font-size:13px;
}
.erro{color:#ff6b6b}
.ok{color:#2ecc71}
.progress{
margin-top:10px;
height:20px;
background:#333;
border-radius:6px;
overflow:hidden;
}
.bar{
height:100%;
width:0%;
background:#2ecc71;
}
</style>
</head>

<body>

<div class="container">

<h2>Importador Profissional de Funcionários</h2>

<label>Unidade destino</label>
<select id="unidade">
<option value="">Selecione</option>
<option>Sabará</option>
<option>Ocidental</option>
<option>Águas Lindas</option>
<option>Cruzeiro da Fortaleza</option>
<option>Guimarânia</option>
</select>

<label>Arquivo Excel</label>
<input type="file" id="arquivo" accept=".xlsx,.xls">

<button onclick="analisar()">Analisar Planilha</button>

<div class="progress">
<div class="bar" id="bar"></div>
</div>

<div class="preview" id="preview"></div>

<button onclick="confirmarImportacao()">Confirmar Importação</button>
<button class="btn-sec" onclick="window.location='dashboard.html'">Cancelar</button>

</div>

<script>

/* segurança */
if(localStorage.getItem("logado")!=="sim") location="login.html"
const usuario=JSON.parse(localStorage.getItem("usuarioLogado"))
if(!usuario||usuario.nome!=="admin"){
alert("Somente admin pode importar")
location="dashboard.html"
}

let dadosProcessados=[]

/* ========================= */
/* ANALISAR PLANILHA */
/* ========================= */

function analisar(){

const unidadeSel=unidade.value
const file=arquivo.files[0]

if(!unidadeSel) return alert("Selecione unidade")
if(!file) return alert("Selecione arquivo")

const reader=new FileReader()

reader.onload=e=>{

const data=new Uint8Array(e.target.result)
const wb=XLSX.read(data,{type:"array"})
const sheet=wb.Sheets[wb.SheetNames[0]]
const linhas=XLSX.utils.sheet_to_json(sheet)

const funcionariosExistentes=JSON.parse(localStorage.getItem("funcionarios"))||[]

dadosProcessados=[]
let erros=[]
let duplicados=0

linhas.forEach((l,i)=>{

let f={}

f.unidade=unidadeSel
f.nome=l["Nome"]||""
f.cpf=String(l["CPF"]||"").trim()
f.nascimento=formatarData(l["Dt. Nascimento"])
f.celular=l["Celular"]||""
f.email=l["Email"]||""
f.cargo=l["FUNÇÃO"]||""
f.cbo=l["CBO"]||""
f.admissao=formatarData(l["Entrada Empresa"])
f.horario=l["Horario de Trabalho"]||""
f.empresa=l["Empresa"]||""
f.cnpj=l["CNPJ"]||""
f.salario=Number(l["Salário"]||0)

if(!f.nome||!f.cpf){
erros.push("Linha "+(i+2)+" sem nome ou CPF")
return
}

const jaExiste=funcionariosExistentes.find(x=>x.cpf===f.cpf)
if(jaExiste){
f.__duplicado=true
duplicados++
}

dadosProcessados.push(f)

})

mostrarPreview(dadosProcessados,erros,duplicados)

}

reader.readAsArrayBuffer(file)
}

/* ========================= */
/* PREVIEW */
/* ========================= */

function mostrarPreview(lista,erros,duplicados){

let html=""

html+=`<div class="ok">Registros válidos: ${lista.length}</div>`
html+=`<div class="erro">Duplicados detectados: ${duplicados}</div>`

erros.forEach(e=>{
html+=`<div class="erro">${e}</div>`
})

html+="<hr>"

lista.slice(0,20).forEach(f=>{
html+=`${f.nome} - ${f.cpf} ${f.__duplicado?"(duplicado)":""}<br>`
})

if(lista.length>20) html+="... mostrando primeiros 20"

preview.innerHTML=html
}

/* ========================= */
/* IMPORTAR */
/* ========================= */

function confirmarImportacao(){

if(!dadosProcessados.length) return alert("Nenhum dado analisado")

if(!confirm("Confirmar importação?")) return

let funcionarios=JSON.parse(localStorage.getItem("funcionarios"))||[]

let total=dadosProcessados.length
let atualizados=0
let novos=0

dadosProcessados.forEach((f,i)=>{

bar.style.width=Math.round((i/total)*100)+"%"

const index=funcionarios.findIndex(x=>x.cpf===f.cpf)

if(index>=0){
funcionarios[index]={...funcionarios[index],...f}
atualizados++
}else{
funcionarios.push(f)
novos++
}

})

bar.style.width="100%"

localStorage.setItem("funcionarios",JSON.stringify(funcionarios))

alert(`
Importação concluída

Novos: ${novos}
Atualizados: ${atualizados}
`)

location="funcionarios.html"
}

/* ========================= */
/* DATA */
/* ========================= */

function formatarData(data){

if(!data) return ""

if(data instanceof Date){
return data.toISOString().split("T")[0]
}

if(typeof data==="string" && data.includes("/")){
const[d,m,a]=data.split("/")
return `${a}-${m}-${d}`
}

return data
}

</script>

</body>
</html>
